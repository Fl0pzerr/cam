<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√©l√©prompter Cam√©ra</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #textOverlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            pointer-events: none;
            overflow-y: auto;
        }

        #displayText {
            color: white;
            font-size: 32px;
            text-align: center;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
            line-height: 1.6;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
        }

        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #textInput {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #222;
            color: white;
            resize: vertical;
            min-height: 60px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        #startBtn {
            background: #4CAF50;
            color: white;
        }

        #startBtn:hover {
            background: #45a049;
        }

        #stopBtn {
            background: #f44336;
            color: white;
            display: none;
        }

        #stopBtn:hover {
            background: #da190b;
        }

        #downloadBtn {
            background: #2196F3;
            color: white;
            display: none;
        }

        #downloadBtn:hover {
            background: #0b7dda;
        }

        .recording-indicator {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .recording-indicator.active {
            display: block;
        }

        #timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
            display: none;
        }

        #timer.active {
            display: block;
        }

        #uploadStatus {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }

        #uploadStatus.active {
            display: block;
        }

        .success {
            background: rgba(76, 175, 80, 0.9) !important;
        }

        .error {
            background: rgba(244, 67, 54, 0.9) !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <video id="videoPreview" autoplay playsinline></video>
        
        <div id="textOverlay">
            <div id="displayText">√âcrivez votre texte ci-dessous...</div>
        </div>

        <div class="recording-indicator" id="recordingIndicator">‚óè REC</div>
        <div id="timer">00:00</div>
        <div id="uploadStatus">Upload en cours...</div>

        <div id="controls">
            <textarea id="textInput" placeholder="Entrez votre texte ici..."></textarea>
            <div class="button-group">
                <button id="startBtn">üé• D√©marrer l'enregistrement</button>
                <button id="stopBtn">‚èπ Arr√™ter</button>
                <button id="downloadBtn">‚¨áÔ∏è T√©l√©charger</button>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let seconds = 0;
        let currentVideoBlob = null;

        const videoPreview = document.getElementById('videoPreview');
        const textInput = document.getElementById('textInput');
        const displayText = document.getElementById('displayText');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const timer = document.getElementById('timer');
        const uploadStatus = document.getElementById('uploadStatus');

        // Mettre √† jour le texte affich√©
        textInput.addEventListener('input', () => {
            displayText.textContent = textInput.value || '√âcrivez votre texte ci-dessous...';
        });

        // D√©marrer la cam√©ra
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user' },
                    audio: true
                });
                videoPreview.srcObject = stream;
            } catch (error) {
                alert('Erreur d\'acc√®s √† la cam√©ra: ' + error.message);
            }
        }

        // Upload automatique vers le serveur
        async function uploadVideo(blob) {
            const formData = new FormData();
            formData.append('video', blob, `video_${Date.now()}.webm`);

            uploadStatus.textContent = 'Upload en cours...';
            uploadStatus.classList.add('active');
            uploadStatus.classList.remove('success', 'error');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    uploadStatus.textContent = '‚úì Vid√©o sauvegard√©e !';
                    uploadStatus.classList.add('success');
                    setTimeout(() => {
                        uploadStatus.classList.remove('active');
                    }, 3000);
                } else {
                    throw new Error('Erreur serveur');
                }
            } catch (error) {
                uploadStatus.textContent = '‚úó Erreur d\'upload';
                uploadStatus.classList.add('error');
                setTimeout(() => {
                    uploadStatus.classList.remove('active');
                }, 3000);
                console.error('Erreur upload:', error);
            }
        }

        // D√©marrer l'enregistrement
        startBtn.addEventListener('click', () => {
            recordedChunks = [];
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'video/webm;codecs=vp9'
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                currentVideoBlob = blob;
                
                // Upload automatique
                uploadVideo(blob);
                
                // Pr√©parer le t√©l√©chargement
                const url = URL.createObjectURL(blob);
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `video_${Date.now()}.webm`;
                    a.click();
                };

                downloadBtn.style.display = 'block';
            };

            mediaRecorder.start();
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'block';
            downloadBtn.style.display = 'none';
            recordingIndicator.classList.add('active');
            timer.classList.add('active');
            
            // D√©marrer le chronom√®tre
            seconds = 0;
            timerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timer.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        });

        // Arr√™ter l'enregistrement
        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            stopBtn.style.display = 'none';
            startBtn.style.display = 'block';
            recordingIndicator.classList.remove('active');
            timer.classList.remove('active');
            clearInterval(timerInterval);
        });

        // Initialiser la cam√©ra au chargement
        startCamera();
    </script>
</body>
</html>